package client;

import java.io.*;
import java.net.*;

import database.*;
import message.*;
import tools.*;

//  此类用于与服务器进行通信，不停地处理消息
public class ChatClient extends Thread {
	private String ServerIP;
	private int port;
	private Socket client;
	private static int OwnIDNum;// 当登陆成功后，为此ChatClient的唯一ID
	private InputStream ins;
	private OutputStream ous;
	
	public ChatClient(String ServerIP, int port) {
		this.ServerIP = ServerIP;
		this.port = port;
	}
	
//	不停地处理消息
	public void run() {
		while (true) {
			try {
				processMsg();
			} catch (IOException e) {
				e.printStackTrace();
				System.out.println("脱离主进程与服务器断开连接");
				JOptionPane.showMessageDialog(null, "与服务器断开连接", "ERROR", JOptionPane.ERROR_MESSAGE);
				System.exit(0);
			}
		}
	}
	
//	连接服务器
	public boolean ConnectServer() {
		try {
			client = new Socket(ServerIP, port);
			System.out.println("服务器已连接");
			ins = client.getInputStream();
			ous = client.getOutputStream();// 获取该连接的输入输出流
			return true;
		} catch (IOException e) {
			// e.printStackTrace();
		}
		return false;
	}
	
//	注
	public boolean Reg(String NikeName, String PassWord) {
		try {
			MsgReg mr = new MsgReg();
			int len = 33; // MsgReg的长度为固定的33
			byte type = 0x01; // MsgReg类型为0x01

			// 设置MsgReg的参数
			mr.setTotalLen(len);
			mr.setType(type);
			mr.setDest(Figures.ServerID); // 服务器的ID
			mr.setSrc(Figures.LoginID);
			mr.setNikeName(NikeName);
			mr.setPwd(PassWord);

			// 打包MsgReg
			byte[] sendMsg = PackageTool.packMsg(mr);
			ous.write(sendMsg);

			// 接收服务器的反馈信息
			byte[] data = receiveMsg();

			// 将数组转换为类
			MsgHead recMsg = ParseTool.parseMsg(data);

			if (recMsg.getType() != 0x11) {// 不是回应注册消息
				System.out.println("通讯协议错误");
				return false;
			}

			MsgRegResp mrr = (MsgRegResp) recMsg;
			// System.out.println("TestHere"+recMsg.getDest());
			if (mrr.getState() == 0) {
				/*
				 * 注册成功
				 */
				System.out.println("注册成功！注缘牡ID为" + mrr.getDest());
				return true;
			} else {
				/*
				 * 注册失败
				 */
				return false;
			}
		} catch (IOException e) {
			e.printStackTrace();
		}
		System.out.println("与服务器断开连接");
		return false;
	}
}
